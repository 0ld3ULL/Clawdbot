{% extends "base.html" %}

{% block title %}Approvals - David Flip Dashboard{% endblock %}

{% block content %}
<h1 style="margin-bottom: 24px;">Pending Approvals</h1>

{% if approvals %}
<p style="color: var(--text-secondary); margin-bottom: 24px;">
    {{ approvals|length }} items waiting for review
</p>

{% for approval in approvals %}
<div class="approval-card" id="approval-{{ approval.id }}">
    <div class="meta">
        <strong>#{{ approval.id }}</strong> |
        <span class="action-type-badge action-{{ approval.action_type }}">{{ approval.action_type }}</span> |
        {{ approval.agent_id }} |
        {{ approval.created_at[:16] }}
    </div>

    {% if approval.action_type in ('tweet', 'reply') %}
    <!-- Tweet/Reply content -->
    <div class="tweet-text" id="text-{{ approval.id }}">
        {{ approval.action_data.text }}
    </div>
    {% if approval.action_type == 'reply' and approval.action_data.tweet_id %}
    <div style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 12px;">
        Replying to tweet {{ approval.action_data.tweet_id }}
    </div>
    {% endif %}
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div class="char-count">
            <span>{{ approval.action_data.text|length }}</span>/280 characters
        </div>
        <div class="actions">
            <button class="btn" onclick="openEditModal({{ approval.id }}, `{{ approval.action_data.text|replace('`', '') }}`)">Edit</button>
            <button class="btn btn-danger" onclick="rejectApproval({{ approval.id }})">Reject</button>
            <button class="btn btn-primary" onclick="approveApproval({{ approval.id }})">Approve & Post</button>
        </div>
    </div>

    {% elif approval.action_type == 'thread' %}
    <!-- Thread content -->
    <div style="margin-bottom: 16px;">
        {% for tweet_text in approval.action_data.get('tweets', []) %}
        <div class="tweet-text" style="margin-bottom: 8px;">
            <span style="color: var(--text-muted); font-size: 0.75rem;">[{{ loop.index }}/{{ approval.action_data.get('tweets', [])|length }}]</span>
            {{ tweet_text }}
        </div>
        {% endfor %}
    </div>
    <div class="actions" style="display: flex; justify-content: flex-end; gap: 12px;">
        <button class="btn btn-danger" onclick="rejectApproval({{ approval.id }})">Reject</button>
        <button class="btn btn-primary" onclick="approveApproval({{ approval.id }})">Approve & Post Thread</button>
    </div>

    {% elif approval.action_type in ('video_distribute', 'video_create', 'video_tweet') %}
    <!-- Video content — redirect to content queue -->
    <div class="tweet-text">
        {{ approval.action_data.get('script', '')[:300] }}{% if approval.action_data.get('script', '')|length > 300 %}...{% endif %}
    </div>
    <div class="actions" style="display: flex; justify-content: flex-end; gap: 12px;">
        <a href="/content" class="btn btn-primary">Review in Content Queue</a>
    </div>

    {% else %}
    <!-- Generic content -->
    <div class="tweet-text">
        {{ approval.action_data.get('text', approval.action_data|string)[:500] }}
    </div>
    <div class="actions" style="display: flex; justify-content: flex-end; gap: 12px;">
        <button class="btn btn-danger" onclick="rejectApproval({{ approval.id }})">Reject</button>
        <button class="btn btn-primary" onclick="approveApproval({{ approval.id }})">Approve & Execute</button>
    </div>
    {% endif %}

    {% if approval.context_summary %}
    <div style="color: var(--text-muted); font-size: 0.8rem; margin-top: 12px;">
        {{ approval.context_summary }}
    </div>
    {% endif %}
</div>
{% endfor %}

{% else %}
<div class="card" style="text-align: center; padding: 60px;">
    <h2 style="color: var(--text-secondary); margin-bottom: 12px;">All Caught Up!</h2>
    <p style="color: var(--text-muted);">No pending approvals right now.</p>
</div>
{% endif %}

<!-- Edit Modal -->
<div class="modal" id="editModal">
    <div class="modal-content">
        <h3 style="margin-bottom: 8px;">Edit Tweet</h3>
        <p style="color: var(--text-secondary); font-size: 0.875rem;">Edit the text and then approve.</p>

        <textarea id="editText" maxlength="280" oninput="updateCharCount()"></textarea>

        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div class="char-count">
                <span id="editCharCount">0</span>/280 characters
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="closeEditModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveEdit()">Save & Approve</button>
            </div>
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div class="modal" id="rejectModal">
    <div class="modal-content">
        <h3 style="margin-bottom: 8px;">Reject</h3>
        <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 16px;">
            Tell David what you didn't like. This feedback goes into his memory.
        </p>
        <textarea id="rejectReason" placeholder="What didn't work? Be specific..." rows="3"></textarea>
        <div class="modal-actions" style="margin-top: 12px;">
            <button class="btn" onclick="closeRejectModal()">Cancel</button>
            <button class="btn btn-danger" onclick="submitReject()">Reject & Send Feedback</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentEditId = null;
let currentRejectId = null;

function openEditModal(id, text) {
    currentEditId = id;
    document.getElementById('editText').value = text;
    document.getElementById('editModal').classList.add('active');
    updateCharCount();
}

function closeEditModal() {
    document.getElementById('editModal').classList.remove('active');
    currentEditId = null;
}

function updateCharCount() {
    const text = document.getElementById('editText').value;
    const count = text.length;
    const countEl = document.getElementById('editCharCount');
    countEl.textContent = count;
    countEl.parentElement.classList.toggle('over', count > 280);
}

function openRejectModal(id) {
    currentRejectId = id;
    document.getElementById('rejectReason').value = '';
    document.getElementById('rejectModal').classList.add('active');
    document.getElementById('rejectReason').focus();
}

function closeRejectModal() {
    document.getElementById('rejectModal').classList.remove('active');
    currentRejectId = null;
}

async function approveApproval(id) {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'Posting...';

    try {
        const response = await fetch(`/api/approve/${id}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        });
        const data = await response.json();

        if (data.success) {
            const card = document.getElementById(`approval-${id}`);
            card.style.opacity = '0.5';
            card.style.transition = 'opacity 0.3s';
            setTimeout(() => card.remove(), 500);
            showNotification('Approved! Oprah will handle it.', 'success');
        } else {
            showNotification('Error: ' + data.error, 'error');
            btn.disabled = false;
            btn.textContent = 'Approve & Post';
        }
    } catch (e) {
        showNotification('Error: ' + e.message, 'error');
        btn.disabled = false;
        btn.textContent = 'Approve & Post';
    }
}

function rejectApproval(id) {
    openRejectModal(id);
}

async function submitReject() {
    if (!currentRejectId) return;

    const reason = document.getElementById('rejectReason').value.trim();
    if (!reason) {
        showNotification('Please explain what you didn\'t like — David needs feedback to improve', 'error');
        return;
    }

    try {
        const response = await fetch(`/api/reject/${currentRejectId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason: reason })
        });
        const data = await response.json();

        if (data.success) {
            const card = document.getElementById(`approval-${currentRejectId}`);
            card.style.opacity = '0.5';
            setTimeout(() => card.remove(), 300);
            closeRejectModal();
            showNotification('Rejected. Feedback saved to David\'s memory.', 'info');
        } else {
            showNotification('Error: ' + data.error, 'error');
        }
    } catch (e) {
        showNotification('Error: ' + e.message, 'error');
    }
}

async function saveEdit() {
    if (!currentEditId) return;

    const text = document.getElementById('editText').value.trim();
    if (!text) {
        showNotification('Text cannot be empty', 'error');
        return;
    }
    if (text.length > 280) {
        showNotification('Tweet exceeds 280 characters', 'error');
        return;
    }

    try {
        const response = await fetch(`/api/edit/${currentEditId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: text })
        });
        const data = await response.json();

        if (data.success) {
            const card = document.getElementById(`approval-${currentEditId}`);
            card.style.opacity = '0.5';
            setTimeout(() => card.remove(), 300);
            closeEditModal();
            showNotification('Edited and approved! Oprah will handle it.', 'success');
        } else {
            showNotification('Error: ' + data.error, 'error');
        }
    } catch (e) {
        showNotification('Error: ' + e.message, 'error');
    }
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        padding: 16px 24px;
        border-radius: 8px;
        background: ${type === 'error' ? '#f85149' : type === 'success' ? '#3fb950' : '#58a6ff'};
        color: white;
        z-index: 1001;
        animation: slideIn 0.3s ease;
        max-width: 400px;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 4000);
}

// Close modals on outside click / Escape
document.getElementById('editModal').addEventListener('click', function(e) {
    if (e.target === this) closeEditModal();
});
document.getElementById('rejectModal').addEventListener('click', function(e) {
    if (e.target === this) closeRejectModal();
});
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeEditModal();
        closeRejectModal();
    }
});
</script>

<style>
@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.action-type-badge {
    font-size: 0.75rem;
    padding: 2px 8px;
    border-radius: 4px;
    font-weight: 600;
}

.action-tweet {
    background: rgba(29, 161, 242, 0.2);
    color: #1da1f2;
}

.action-thread {
    background: rgba(88, 166, 255, 0.2);
    color: var(--accent-blue);
}

.action-reply {
    background: rgba(210, 153, 34, 0.2);
    color: var(--accent-yellow);
}

.action-video_distribute, .action-video_create, .action-video_tweet {
    background: rgba(163, 113, 247, 0.2);
    color: var(--accent-purple);
}

#rejectReason {
    width: 100%;
    min-height: 80px;
    background: var(--bg-dark);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-primary);
    padding: 12px;
    font-size: 0.95rem;
    resize: vertical;
    font-family: inherit;
}

#rejectReason:focus {
    outline: none;
    border-color: var(--accent-blue);
}
</style>
{% endblock %}
