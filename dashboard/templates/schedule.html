{% extends "base.html" %}
{% block title %}Schedule — Mission Control{% endblock %}
{% block content %}
<style>
    .coverage-banner {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 12px;
        margin-bottom: 20px;
    }
    .coverage-stat {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 16px;
        text-align: center;
    }
    .coverage-stat .value {
        font-size: 1.75rem;
        font-weight: 600;
    }
    .coverage-stat .label {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-top: 4px;
    }
    .gap-alert {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 14px 20px;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 0.9rem;
    }
    .gap-alert .indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        flex-shrink: 0;
    }
    .calendar-grid {
        display: grid;
        grid-template-columns: 80px repeat(7, 1fr);
        gap: 2px;
        margin-bottom: 32px;
    }
    .cal-header {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 10px 4px;
        text-align: center;
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--text-secondary);
    }
    .cal-header.today {
        border-color: var(--accent-blue);
        color: var(--accent-blue);
    }
    .time-label {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 8px 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        color: var(--text-muted);
        font-weight: 500;
    }
    .cal-cell {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 6px;
        min-height: 80px;
        overflow: hidden;
    }
    .cal-cell.empty {
        border-style: dashed;
        border-color: var(--bg-hover);
    }
    .cal-cell.past {
        opacity: 0.55;
    }
    .slot-item {
        padding: 5px 7px;
        border-radius: 4px;
        font-size: 0.7rem;
        line-height: 1.3;
        margin-bottom: 4px;
        border-left: 3px solid;
    }
    .slot-item:last-child { margin-bottom: 0; }
    .slot-item.s-pending   { background: rgba(210,153,34,0.1);  border-left-color: var(--accent-yellow); }
    .slot-item.s-approved  { background: rgba(88,166,255,0.1);  border-left-color: var(--accent-blue); }
    .slot-item.s-scheduled { background: rgba(163,113,247,0.1); border-left-color: var(--accent-purple); }
    .slot-item.s-posted    { background: rgba(63,185,80,0.1);   border-left-color: var(--accent-green); }
    .slot-item.s-failed    { background: rgba(248,81,73,0.1);   border-left-color: var(--accent-red); }
    .sbadge {
        display: inline-block;
        padding: 1px 5px;
        border-radius: 3px;
        font-size: 0.6rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    .sbadge.pending   { background: rgba(210,153,34,0.2);  color: var(--accent-yellow); }
    .sbadge.approved  { background: rgba(88,166,255,0.2);  color: var(--accent-blue); }
    .sbadge.scheduled { background: rgba(163,113,247,0.2); color: var(--accent-purple); }
    .sbadge.posted    { background: rgba(63,185,80,0.2);   color: var(--accent-green); }
    .sbadge.failed    { background: rgba(248,81,73,0.2);   color: var(--accent-red); }
    .pbadge {
        display: inline-block;
        padding: 1px 4px;
        border-radius: 2px;
        font-size: 0.6rem;
        background: var(--bg-hover);
        color: var(--text-muted);
    }
    .recent-table {
        width: 100%;
        border-collapse: collapse;
    }
    .recent-table th, .recent-table td {
        padding: 10px 12px;
        text-align: left;
        border-bottom: 1px solid var(--border);
        font-size: 0.875rem;
    }
    .recent-table th {
        color: var(--text-secondary);
        font-weight: 500;
    }
    .recent-table tr:hover {
        background: var(--bg-hover);
    }
</style>

<h2 style="margin-bottom: 20px; font-size: 1.25rem;">Schedule</h2>

<!-- Coverage Banner -->
<div class="coverage-banner">
    <div class="coverage-stat" style="border-color: var(--accent-yellow);">
        <div class="value" style="color: var(--accent-yellow);">{{ stats.pending }}</div>
        <div class="label">Pending</div>
    </div>
    <div class="coverage-stat" style="border-color: var(--accent-blue);">
        <div class="value" style="color: var(--accent-blue);">{{ stats.approved }}</div>
        <div class="label">Approved</div>
    </div>
    <div class="coverage-stat" style="border-color: var(--accent-purple);">
        <div class="value" style="color: var(--accent-purple);">{{ stats.scheduled }}</div>
        <div class="label">Scheduled</div>
    </div>
    <div class="coverage-stat" style="border-color: var(--accent-green);">
        <div class="value" style="color: var(--accent-green);">{{ stats.posted }}</div>
        <div class="label">Posted (7d)</div>
    </div>
    <div class="coverage-stat" style="border-color: var(--accent-red);">
        <div class="value" style="color: var(--accent-red);">{{ stats.failed }}</div>
        <div class="label">Failed</div>
    </div>
</div>

<!-- Gap Alert -->
<div class="gap-alert">
    {% if stats.gaps == 0 %}
    <div class="indicator" style="background: var(--accent-green); box-shadow: 0 0 8px var(--accent-green);"></div>
    <span>All optimal slots filled for the next 3 days</span>
    {% elif stats.gaps <= 4 %}
    <div class="indicator" style="background: var(--accent-yellow); box-shadow: 0 0 8px var(--accent-yellow);"></div>
    <span>{{ stats.gaps }} empty slot{{ 's' if stats.gaps != 1 else '' }} ahead{% if next_empty %} &mdash; next gap: <strong>{{ next_empty }}</strong>{% endif %}</span>
    {% else %}
    <div class="indicator" style="background: var(--accent-red); box-shadow: 0 0 8px var(--accent-red);"></div>
    <span>{{ stats.gaps }} empty slots ahead{% if next_empty %} &mdash; next gap: <strong>{{ next_empty }}</strong>{% endif %}</span>
    {% endif %}
</div>

<!-- Calendar Grid -->
<div class="calendar-grid">
    <!-- Header row: corner + 7 day columns -->
    <div class="cal-header" style="font-size: 0.65rem; color: var(--text-muted);">UTC</div>
    {% for day in days %}
    <div class="cal-header {% if day.is_today %}today{% endif %}">
        {{ day.label }}
        {% if day.is_today %}<br><span style="font-size: 0.6rem; color: var(--accent-blue);">TODAY</span>{% endif %}
    </div>
    {% endfor %}

    <!-- Time slot rows -->
    {% for hour in optimal_hours %}
    <div class="time-label">{{ hour_labels[hour] }}</div>
    {% for day in days %}
    {% set items = day.slots[hour] %}
    <div class="cal-cell {% if not items %}empty{% endif %} {% if day.is_past %}past{% endif %}">
        {% for item in items %}
        <div class="slot-item s-{{ item.status }}">
            <span class="sbadge {{ item.status }}">{{ item.status }}</span>
            <span class="pbadge">{{ item.platform|upper if item.platform else 'X' }}</span>
            <div style="margin-top: 2px; color: var(--text-secondary); font-size: 0.68rem;">{{ item.text[:60] }}{% if item.text|length > 60 %}…{% endif %}</div>
        </div>
        {% endfor %}
    </div>
    {% endfor %}
    {% endfor %}
</div>

<!-- Pending Approvals -->
{% if pending_items %}
<div class="card">
    <div class="card-header">
        <span class="card-title">Awaiting Approval ({{ pending_items|length }})</span>
        <span style="font-size: 0.8rem; color: var(--text-muted);">Not yet scheduled</span>
    </div>
    {% for item in pending_items %}
    <div style="padding: 10px 0; border-bottom: 1px solid var(--border);">
        <span class="sbadge pending">pending</span>
        <span style="color: var(--text-muted); font-size: 0.75rem; margin-left: 6px;">{{ item.type }}</span>
        <span style="color: var(--text-muted); font-size: 0.75rem; margin-left: 8px;">{{ item.created_at[:16] }}</span>
        <div style="margin-top: 4px; color: var(--text-secondary); font-size: 0.875rem;">{{ item.text[:120] }}{% if item.text|length > 120 %}…{% endif %}</div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Recent Posts -->
<div class="card">
    <div class="card-header">
        <span class="card-title">Recent Posts</span>
        <span style="font-size: 0.8rem; color: var(--text-muted);">Last 7 days</span>
    </div>
    {% if recent_posted %}
    <table class="recent-table">
        <thead>
            <tr>
                <th>Time (UTC)</th>
                <th>Status</th>
                <th>Type</th>
                <th>Content</th>
            </tr>
        </thead>
        <tbody>
            {% for item in recent_posted %}
            <tr>
                <td style="color: var(--text-muted); white-space: nowrap;">{{ item.scheduled_time[:16] }}</td>
                <td><span class="sbadge {{ item.status }}">{{ item.status }}</span></td>
                <td style="color: var(--text-muted);">{{ item.type }}</td>
                <td style="color: var(--text-secondary);">{{ item.text[:100] }}{% if item.text|length > 100 %}…{% endif %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: var(--text-muted); padding: 20px 0; text-align: center;">No posts in the last 7 days.</p>
    {% endif %}
</div>
{% endblock %}
